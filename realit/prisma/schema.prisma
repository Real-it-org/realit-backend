generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

model users {
  id            String @id @default(uuid())
  email         String @db.Citext
  username      String @db.Citext
  password_hash String

  is_email_verified Boolean @default(false)
  is_active         Boolean @default(true)

  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  refresh_tokens refresh_tokens[]
  profile        profiles?
  push_tokens    push_tokens[]

  @@unique([email])
  @@unique([username])
}

model refresh_tokens {
  id         String   @id @default(uuid())
  user_id    String
  token_hash String
  is_revoked Boolean  @default(false)
  expires_at DateTime
  created_at DateTime @default(now())

  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model push_tokens {
  id      String @id @default(uuid())
  user_id String
  user    users  @relation(fields: [user_id], references: [id], onDelete: Cascade)

  token    String @unique // FCM / APNs device token
  platform String // "ios" | "android"

  created_at DateTime @default(now())

  @@index([user_id])
}

enum MediaType {
  image
  video
}

enum VerificationStatus {
  verified
  ai
  unverified
}

enum MediaStatus {
  pending
  uploaded
  processing
  active
  failed
}

enum NotificationType {
  follow // public follow completed
  follow_request // request to follow a private profile
  follow_accepted // private profile accepted your request
  like
  comment
}

enum FollowRequestStatus {
  pending
  accepted
  rejected
}

model profiles {
  id      String @id @default(uuid())
  user_id String @unique
  user    users  @relation(fields: [user_id], references: [id], onDelete: Cascade)

  username     String  @unique @db.Citext
  display_name String?
  bio          String?
  avatar_url   String?
  website      String?

  is_private Boolean @default(false)

  followers_count            Int @default(0)
  following_count            Int @default(0)
  posts_count                Int @default(0)
  unread_notifications_count Int @default(0)

  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  followers follows[]  @relation("following")
  following follows[]  @relation("follower")
  posts     posts[]
  likes     likes[]
  comments  comments[]

  received_notifications   notifications[]   @relation("received_notifications")
  sent_notifications       notifications[]   @relation("sent_notifications")
  received_follow_requests follow_requests[] @relation("received_requests")
  sent_follow_requests     follow_requests[] @relation("sent_requests")
}

model follows {
  follower_id String
  follower    profiles @relation("follower", fields: [follower_id], references: [id], onDelete: Cascade)

  following_id String
  following    profiles @relation("following", fields: [following_id], references: [id], onDelete: Cascade)

  created_at DateTime @default(now())

  @@id([follower_id, following_id])
}

model follow_requests {
  id String @id @default(uuid())

  requester_profile_id String
  requester            profiles @relation("sent_requests", fields: [requester_profile_id], references: [id], onDelete: Cascade)

  target_profile_id String
  target            profiles @relation("received_requests", fields: [target_profile_id], references: [id], onDelete: Cascade)

  status FollowRequestStatus @default(pending)

  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  // No @@unique — row is hard-deleted on reject, allowing re-requests
  @@index([target_profile_id, status])
  @@index([requester_profile_id, target_profile_id])
}

model notifications {
  id String @id @default(uuid())

  recipient_profile_id String
  recipient            profiles @relation("received_notifications", fields: [recipient_profile_id], references: [id], onDelete: Cascade)

  actor_profile_id String
  actor            profiles @relation("sent_notifications", fields: [actor_profile_id], references: [id], onDelete: Cascade)

  type NotificationType

  // Post context — Cascade: notification deleted when post is deleted
  post_id String?
  post    posts?  @relation(fields: [post_id], references: [id], onDelete: Cascade)

  // Comment context — Cascade: notification deleted when comment is deleted
  comment_id String?
  comment    comments? @relation(fields: [comment_id], references: [id], onDelete: Cascade)

  is_read    Boolean  @default(false)
  created_at DateTime @default(now())

  @@index([recipient_profile_id, is_read])
  @@index([recipient_profile_id, created_at(sort: Desc)])
}

model posts {
  id         String   @id @default(uuid())
  profile_id String
  profile    profiles @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  heading             String?
  description         String?
  media               post_media[]
  verification_status VerificationStatus @default(unverified)

  likes_count    Int @default(0)
  comments_count Int @default(0)

  created_at DateTime @default(now())

  likes         likes[]
  comments      comments[]
  notifications notifications[]
}

model likes {
  profile_id String
  profile    profiles @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  post_id String
  post    posts  @relation(fields: [post_id], references: [id], onDelete: Cascade)

  created_at DateTime @default(now())

  @@id([profile_id, post_id])
}

model comments {
  id      String @id @default(uuid())
  post_id String
  post    posts  @relation(fields: [post_id], references: [id], onDelete: Cascade)

  profile_id String
  profile    profiles @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  content String

  created_at DateTime @default(now())

  notifications notifications[]
}

model post_media {
  id          String      @id @default(uuid())
  post_id     String
  post        posts       @relation(fields: [post_id], references: [id], onDelete: Cascade)
  media_url   String
  media_type  MediaType
  position    Int
  status      MediaStatus @default(pending)
  size_bytes  BigInt
  object_key  String
  duration_ms Int?

  created_at DateTime @default(now())
}
